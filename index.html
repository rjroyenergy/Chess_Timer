<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">

    <!-- Mobile-first viewport (prevents zooming, improves touch behavior) -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

    <title>Chess Timer</title>

    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background: #111;
            color: white;
            display: flex;
            flex-direction: column;
            height: 100vh;
            user-select: none;
            touch-action: manipulation;
        }

        /* Player Name Bar */
        #nameBar {
            background: #000;
            padding: 12px;
            text-align: center;
        }

        #nameBar button {
            padding: 16px 24px;
            font-size: 1.3rem;
            border: none;
            border-radius: 8px;
            background: #777;
            color: white;
            cursor: pointer;
            margin: 4px;
        }

        #nameBar button:hover {
            background: #888;
        }

        /* Player Panels (Mobile-first) */
        .player {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 0;
            font-size: 3.2rem;
            transition: background 0.2s;
            position: relative;
        }

        #p1 { background: #333; }
        #p2 { background: #444; }
        .active { background: #006600 !important; }

        .playerName {
            font-size: 1.4rem;
            margin-bottom: 6px;
            color: #ddd;
        }

        .nameSelect {
            font-size: 1.2rem;
            padding: 10px;
            margin-bottom: 12px;
            border-radius: 5px;
            background: #222;
            color: white;
            width: 70%;
        }

        .time {
            font-size: 3.4rem;
            transition: color 0.3s ease;
            margin-top: 8px;
        }

        .low-time { color: #ff4444 !important; }
        .flash-time { animation: flashRed 0.5s infinite; }

        @keyframes flashRed {
            0%, 50% { color: #ff4444; }
            51%, 100% { color: white; }
        }

        /* King Icons (Mobile-first scaling) */
        .king-icon {
            width: 28vw;
            height: 28vw;
            max-width: 160px;
            max-height: 160px;
            object-fit: contain;
            margin-bottom: 10px;
            background: transparent;
            display: block;
            pointer-events: none;
            transition: transform 0.4s ease;
            image-rendering: crisp-edges;
            will-change: transform;
        }

        /* Wobble animation at 10 seconds */
        @keyframes kingWobble {
            0%   { transform: rotate(0deg); }
            25%  { transform: rotate(-8deg); }
            50%  { transform: rotate(8deg); }
            75%  { transform: rotate(-8deg); }
            100% { transform: rotate(0deg); }
        }
        .wobbling {
            animation: kingWobble 0.4s infinite ease-in-out;
        }

        /* Fall animation */
        @keyframes kingFall {
            0% { transform: rotate(0deg); }
            20% { transform: rotate(-10deg); }
            100% { transform: rotate(90deg); }
        }
        .falling {
            animation: kingFall 0.6s ease forwards;
        }

        /* Crown animation */
        .crown-icon {
            width: 120px;
            height: 120px;
            position: absolute;
            top: -140px;
            opacity: 0;
            pointer-events: none;
            transform: translateY(-40px) scale(0.8);
        }

        @keyframes crownDrop {
            0%   { opacity: 0; transform: translateY(-40px) scale(0.8); }
            60%  { opacity: 1; transform: translateY(10px) scale(1.05); }
            80%  { transform: translateY(-5px) scale(1.0); }
            100% { transform: translateY(0px) scale(1.0); }
        }

        .crown-animate {
            animation: crownDrop 0.6s ease-out forwards;
        }

        /* Controls (Mobile-first) */
        .controls {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 12px;
            padding: 14px;
            background: #000;
        }

        button {
            padding: 16px 24px;
            font-size: 1.3rem;
            border: none;
            border-radius: 8px;
            background: #555;
            color: white;
            cursor: pointer;
            margin: 4px;
        }

        button:hover { background: #666; }

        .hidden { display: none !important; }

        /* Winner selector popup */
        #winnerPopup,
        #resetPopup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #222;
            padding: 28px;
            border-radius: 10px;
            text-align: center;
            display: none;
            z-index: 999;
            width: 85%;
            max-width: 380px;
            font-size: 1.2rem;
        }

        #winnerPopup button,
        #resetPopup button {
            padding: 14px 20px;
            font-size: 1.2rem;
            margin: 10px;
        }
    </style>
</head>

<body>

    <!-- Player Name Bar -->
    <div id="nameBar">
        <button id="setNames">Set Player Names</button>
        <button id="swapNames">Swap Names</button>
    </div>

    <div id="p1" class="player">
        <select id="p1select" class="nameSelect"></select>
        <div id="p1name" class="playerName">White</div>
        <img src="crown.png" class="crown-icon hidden" id="crown1">
        <img src="white_king.png" class="king-icon" alt="White King">
        <div id="p1time" class="time">15:00</div>
    </div>

    <div id="p2" class="player">
        <select id="p2select" class="nameSelect"></select>
        <div id="p2name" class="playerName">Black</div>
        <img src="crown.png" class="crown-icon hidden" id="crown2">
        <img src="black_king.png" class="king-icon" alt="Black King">
        <div id="p2time" class="time">15:00</div>
    </div>

    <div class="controls">
        <button id="start">Start</button>
        <button id="reset">Reset / Pause</button>
        <button id="setTime" class="set-time-btn">Set Time</button>
        <button id="declareWinner">Check Mate</button>
        <button id="declareDraw">Stale Mate</button>
        <button id="viewStats">Player Stats</button>
    </div>

    <!-- Winner selection popup -->
    <div id="winnerPopup">
        <h2>Select Winner</h2>
        <button id="whiteWins">White Wins</button>
        <button id="blackWins">Black Wins</button>
        <button id="cancelWinner">Cancel</button>
    </div>

    <!-- Reset confirmation popup -->
    <div id="resetPopup" class="hidden">
        <h2>Game Timer Paused</h2>
        <p>Are you sure you want to reset?</p>
        <button id="resetYes">OK</button>
        <button id="resetNo">Cancel</button>
    </div>
/* 
   Title: Chess Timer (Mobile‑First Version)
   File: chess-timer.html
   Description: Part 2 of 3 — Contains the remainder of the HTML body and opens the script tag. 
                No logic changes. This part continues directly from Part 1.
*/
/* Part 2 of 3 */

    <!-- Reset confirmation popup -->
    <div id="resetPopup" class="hidden">
        <h2>Game Timer Paused</h2>
        <p>Are you sure you want to reset?</p>
        <button id="resetYes">OK</button>
        <button id="resetNo">Cancel</button>
    </div>

    <!-- BEGIN FULL JAVASCRIPT BLOCK -->
    <script>
/* 
   Title: Chess Timer (Mobile‑First Version)
   File: chess-timer.html
   Description: Part 3 of 3 — Contains the full JavaScript logic restored from the last known good version.
                No logic changes. Fully integrated with the mobile‑first redesign.
*/
/* Part 3 of 3 */

        let timeStart = 15 * 60;
        let t1 = timeStart;
        let t2 = timeStart;
        let active = 0;
        let interval = null;

        const p1 = document.getElementById('p1');
        const p2 = document.getElementById('p2');
        const p1time = document.getElementById('p1time');
        const p2time = document.getElementById('p2time');
        const p1name = document.getElementById('p1name');
        const p2name = document.getElementById('p2name');
        const setNamesBtn = document.getElementById('setNames');
        const swapNamesBtn = document.getElementById('swapNames');
        const setTimeBtn = document.getElementById('setTime');
        const startBtn = document.getElementById('start');
        const popup = document.getElementById('winnerPopup');
        const resetPopup = document.getElementById('resetPopup');

        /* -------------------------------
           Persistent Player Name Storage
        --------------------------------*/
        let savedNames = JSON.parse(localStorage.getItem("playerNames") || "[]");

        function saveName(name) {
            const lower = name.toLowerCase();
            if (!savedNames.some(n => n.toLowerCase() === lower)) {
                savedNames.push(name);
                localStorage.setItem("playerNames", JSON.stringify(savedNames));
                populateDropdowns();
            }
        }

        function populateDropdowns() {
            const p1select = document.getElementById("p1select");
            const p2select = document.getElementById("p2select");

            p1select.innerHTML = "";
            p2select.innerHTML = "";

            savedNames.forEach(n => {
                const opt1 = document.createElement("option");
                opt1.value = n;
                opt1.textContent = n;
                p1select.appendChild(opt1);

                const opt2 = document.createElement("option");
                opt2.value = n;
                opt2.textContent = n;
                p2select.appendChild(opt2);
            });

            p1select.value = p1name.textContent;
            p2select.value = p2name.textContent;
        }

        populateDropdowns();

        document.getElementById("p1select").addEventListener("change", e => {
            if (e.target.value.toLowerCase() === p2name.textContent.toLowerCase()) {
                alert("White and Black cannot have the same name.");
                e.target.value = "";
                return;
            }
            p1name.textContent = e.target.value;
        });

        document.getElementById("p2select").addEventListener("change", e => {
            if (e.target.value.toLowerCase() === p1name.textContent.toLowerCase()) {
                alert("White and Black cannot have the same name.");
                e.target.value = "";
                return;
            }
            p2name.textContent = e.target.value;
        });

        /* Player Name Button Logic */
        setNamesBtn.onclick = () => {
            const white = prompt("Enter White's name:", p1name.textContent);
            if (white !== null && white.trim() !== "") {
                if (white.toLowerCase() === p2name.textContent.toLowerCase()) {
                    alert("White and Black cannot have the same name.");
                    return;
                }
                p1name.textContent = white;
                saveName(white);
            }

            const black = prompt("Enter Black's name:", p2name.textContent);
            if (black !== null && black.trim() !== "") {
                if (black.toLowerCase() === p1name.textContent.toLowerCase()) {
                    alert("White and Black cannot have the same name.");
                    return;
                }
                p2name.textContent = black;
                saveName(black);
            }

            populateDropdowns();
        };

        /* -------------------------------
           Swap Names Button Logic
        --------------------------------*/
        swapNamesBtn.onclick = () => {
            const temp = p1name.textContent;
            p1name.textContent = p2name.textContent;
            p2name.textContent = temp;

            const p1select = document.getElementById("p1select");
            const p2select = document.getElementById("p2select");

            const tempSel = p1select.value;
            p1select.value = p2select.value;
            p2select.value = tempSel;

            p1select.value = p1name.textContent;
            p2select.value = p2name.textContent;
        };

        /* -------------------------------
           Player Stats (Case-Insensitive)
        --------------------------------*/
        let playerStats = JSON.parse(localStorage.getItem("playerStats") || "{}");

        function saveStats() {
            localStorage.setItem("playerStats", JSON.stringify(playerStats));
        }

        function ensurePlayerStats(name) {
            const key = name.toLowerCase();
            if (!playerStats[key]) {
                playerStats[key] = {
                    name: name,
                    games: 0,
                    wins: 0,
                    losses: 0,
                    draws: 0,
                    timeUsed: 0
                };
            }
        }

        function recordStats(winner, used1, used2) {
            const white = p1name.textContent;
            const black = p2name.textContent;

            const wKey = white.toLowerCase();
            const bKey = black.toLowerCase();

            ensurePlayerStats(white);
            ensurePlayerStats(black);

            playerStats[wKey].games++;
            playerStats[bKey].games++;

            playerStats[wKey].timeUsed += used1;
            playerStats[bKey].timeUsed += used2;

            if (winner === "white") {
                playerStats[wKey].wins++;
                playerStats[bKey].losses++;
            } else if (winner === "black") {
                playerStats[bKey].wins++;
                playerStats[wKey].losses++;
            } else {
                playerStats[wKey].draws++;
                playerStats[bKey].draws++;
            }

            saveStats();
        }

        document.getElementById("viewStats").onclick = () => {
            let msg = "Player Statistics:\n\n";

            for (const key in playerStats) {
                const s = playerStats[key];
                msg += `${s.name}\n`;
                msg += `  Games: ${s.games}\n`;
                msg += `  Wins: ${s.wins}\n`;
                msg += `  Losses: ${s.losses}\n`;
                msg += `  Draws: ${s.draws}\n`;
                msg += `  Total Time Used: ${Math.floor(s.timeUsed / 60)}m ${s.timeUsed % 60}s\n\n`;
            }

            alert(msg);
        };

        /* -------------------------------
           HARD RULE ENFORCEMENT
        --------------------------------*/
        function hideAllButtonsExceptReset() {
            startBtn.classList.add('hidden');
            setNamesBtn.classList.add('hidden');
            swapNamesBtn.classList.add('hidden');
            setTimeBtn.classList.add('hidden');
            document.getElementById("declareWinner").classList.add('hidden');
            document.getElementById("declareDraw").classList.add('hidden');
            document.getElementById("viewStats").classList.add('hidden');
        }

        function showAllButtons() {
            startBtn.classList.remove('hidden');
            setNamesBtn.classList.remove('hidden');
            swapNamesBtn.classList.remove('hidden');
            setTimeBtn.classList.remove('hidden');
            document.getElementById("declareWinner").classList.remove('hidden');
            document.getElementById("declareDraw").classList.remove('hidden');
            document.getElementById("viewStats").classList.remove('hidden');
        }

        /* -------------------------------
           Timer Logic
        --------------------------------*/
        function updateTimeColors() {
            p1time.classList.remove('low-time', 'flash-time');
            p2time.classList.remove('low-time', 'flash-time');

            const k1 = document.querySelector('#p1 img.king-icon');
            const k2 = document.querySelector('#p2 img.king-icon');

            k1.classList.remove('wobbling');
            k2.classList.remove('wobbling');

            if (t1 <= 10 && t1 > 0) k1.classList.add('wobbling');
            else if (t1 < 30) p1time.classList.add('flash-time');
            else if (t1 < 60) p1time.classList.add('low-time');

            if (t2 <= 10 && t2 > 0) k2.classList.add('wobbling');
            else if (t2 < 30) p2time.classList.add('flash-time');
            else if (t2 < 60) p2time.classList.add('low-time');
        }

        function format(t) {
            const m = Math.floor(t / 60);
            const s = t % 60;
            return String(m).padStart(2, '0') + ':' + String(s).padStart(2, '0');
        }

        function update() {
            p1time.textContent = format(t1);
            p2time.textContent = format(t2);
            updateTimeColors();
        }

        function resetTimer() {
            clearInterval(interval);
            interval = null;
            active = 0;
            t1 = timeStart;
            t2 = timeStart;

            p1.classList.remove('active');
            p2.classList.remove('active');

            const k1 = document.querySelector('#p1 img.king-icon');
            const k2 = document.querySelector('#p2 img.king-icon');
            k1.classList.remove('falling', 'wobbling');
            k2.classList.remove('falling', 'wobbling');

            document.getElementById('crown1').classList.add('hidden');
            document.getElementById('crown2').classList.add('hidden');
            document.getElementById('crown1').classList.remove('crown-animate');
            document.getElementById('crown2').classList.remove('crown-animate');

            p1time.classList.remove('flash-time', 'low-time');
            p2time.classList.remove('flash-time', 'low-time');

            showAllButtons();

            document.getElementById("p1select").classList.remove("hidden");
            document.getElementById("p2select").classList.remove("hidden");

            update();
        }

        function tick() {
            if (active === 1 && t1 > 0) t1--;
            if (active === 2 && t2 > 0) t2--;
            update();

            if (t1 <= 0) endGame("White's time expired — Black wins", "black");
            if (t2 <= 0) endGame("Black's time expired — White wins", "white");
        }

        function endGame(resultText, winner = null) {
            clearInterval(interval);
            interval = null;
            active = 0;

            const k1 = document.querySelector('#p1 img.king-icon');
            const k2 = document.querySelector('#p2 img.king-icon');

            k1.classList.remove('wobbling');
            k2.classList.remove('wobbling');

            p1time.classList.remove('flash-time', 'low-time');
            p2time.classList.remove('flash-time', 'low-time');

            const crown1 = document.getElementById('crown1');
            const crown2 = document.getElementById('crown2');

            crown1.classList.add('hidden');
            crown2.classList.add('hidden');
            crown1.classList.remove('crown-animate');
            crown2.classList.remove('crown-animate');

            if (winner === "white") {
                crown1.classList.remove('hidden');
                void crown1.offsetWidth;
                crown1.classList.add('crown-animate');
                k2.classList.add('falling');
            } else if (winner === "black") {
                crown2.classList.remove('hidden');
                void crown2.offsetWidth;
                crown2.classList.add('crown-animate');
                k1.classList.add('falling');
            }

            hideAllButtonsExceptReset();

            document.getElementById("p1select").classList.remove("hidden");
            document.getElementById("p2select").classList.remove("hidden");

            const used1 = timeStart - t1;
            const used2 = timeStart - t2;

            recordStats(winner, used1, used2);
            showSummary(resultText);
        }

        function showSummary(result) {
            const used1 = timeStart - t1;
            const used2 = timeStart - t2;

            const mins1 = Math.floor(used1 / 60);
            const secs1 = used1 % 60;

            const mins2 = Math.floor(used2 / 60);
            const secs2 = used2 % 60;

            alert(
                "Game Result: " + result + "\n\n" +
                p1name.textContent + " used: " + mins1 + "m " + secs1 + "s\n" +
                p2name.textContent + " used: " + mins2 + "m " + secs2 + "s\n"
            );
        }

        p1.addEventListener('click', () => {
            if (!interval) return;
            active = 2;
            p1.classList.remove('active');
            p2.classList.add('active');
            update();
        });

        p2.addEventListener('click', () => {
            if (!interval) return;
            active = 1;
            p2.classList.remove('active');
            p1.classList.add('active');
            update();
        });

        /* -------------------------------
           START BUTTON — HARD RULE APPLIED
        --------------------------------*/
        startBtn.onclick = () => {
            if (interval) return;

            active = 1;
            p1.classList.add('active');
            interval = setInterval(tick, 1000);

            hideAllButtonsExceptReset();

            document.getElementById("p1select").classList.add("hidden");
            document.getElementById("p2select").classList.add("hidden");
        };

        /* -------------------------------
           RESET / PAUSE BUTTON
        --------------------------------*/
        document.getElementById('reset').onclick = () => {
            clearInterval(interval);
            interval = null;

            resetPopup.classList.remove("hidden");
        };

        document.getElementById("resetYes").onclick = () => {
            resetPopup.classList.add("hidden");
            resetTimer();
        };

        document.getElementById("resetNo").onclick = () => {
            resetPopup.classList.add("hidden");

            if (active === 1 || active === 2) {
                interval = setInterval(tick, 1000);
            }
        };

        /* -------------------------------
           SET TIME BUTTON
        --------------------------------*/
        document.getElementById('setTime').onclick = () => {
            const minutes = prompt('Enter minutes per side (default 15):', 15);
            if (minutes === null) return;
            const m = parseInt(minutes);
            if (isNaN(m) || m < 0) {
                alert('Please enter a valid number.');
                return;
            }
            timeStart = m * 60;
            resetTimer();
        };

        /* -------------------------------
           WINNER POPUP BUTTONS
        --------------------------------*/
        document.getElementById('declareWinner').onclick = () => {
            popup.style.display = "block";
        };

        document.getElementById('whiteWins').onclick = () => {
            popup.style.display = "none";
            endGame(p1name.textContent + " wins by Checkmate", "white");
        };

        document.getElementById('blackWins').onclick = () => {
            popup.style.display = "none";
            endGame(p2name.textContent + " wins by Checkmate", "black");
        };

        document.getElementById('cancelWinner').onclick = () => {
            popup.style.display = "none";
        };

        document.getElementById('declareDraw').onclick = () => {
            endGame("Stalemate — Draw Declared", null);
        };

        update();

    </script>

</body>
</html>

/* End of Part 3 */
/* EOF */
