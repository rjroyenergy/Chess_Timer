            if (t1 <= 0) endGame("White's time expired — Black wins", "black");
            if (t2 <= 0) endGame("Black's time expired — White wins", "white");
        }

        function endGame(resultText, winner = null) {
            clearInterval(interval);
            interval = null;
            active = 0;

            const k1 = document.querySelector('#p1 img.king-icon');
            const k2 = document.querySelector('#p2 img.king-icon');

            k1.classList.remove('wobbling');
            k2.classList.remove('wobbling');

            p1time.classList.remove('flash-time', 'low-time');
            p2time.classList.remove('flash-time', 'low-time');

            const crown1 = document.getElementById('crown1');
            const crown2 = document.getElementById('crown2');

            crown1.classList.add('hidden');
            crown2.classList.add('hidden');
            crown1.classList.remove('crown-animate');
            crown2.classList.remove('crown-animate');

            if (winner === "white") {
                crown1.classList.remove('hidden');
                void crown1.offsetWidth;
                crown1.classList.add('crown-animate');
                k2.classList.add('falling');
            } else if (winner === "black") {
                crown2.classList.remove('hidden');
                void crown2.offsetWidth;
                crown2.classList.add('crown-animate');
                k1.classList.add('falling');
            }

            hideAllButtonsExceptReset();

            document.getElementById("p1select").classList.remove("hidden");
            document.getElementById("p2select").classList.remove("hidden");

            const used1 = timeStart - t1;
            const used2 = timeStart - t2;

            recordStats(winner, used1, used2);
            showSummary(resultText);
        }

        function showSummary(result) {
            const used1 = timeStart - t1;
            const used2 = timeStart - t2;

            const mins1 = Math.floor(used1 / 60);
            const secs1 = used1 % 60;

            const mins2 = Math.floor(used2 / 60);
            const secs2 = used2 % 60;

            alert(
                "Game Result: " + result + "\n\n" +
                p1name.textContent + " used: " + mins1 + "m " + secs1 + "s\n" +
                p2name.textContent + " used: " + mins2 + "m " + secs2 + "s\n"
            );
        }

        p1.addEventListener('click', () => {
            if (!interval) return;
            active = 2;
            p1.classList.remove('active');
            p2.classList.add('active');
            update();
        });

        p2.addEventListener('click', () => {
            if (!interval) return;
            active = 1;
            p2.classList.remove('active');
            p1.classList.add('active');
            update();
        });

        startBtn.onclick = () => {
            if (interval) return;

            active = 1;
            p1.classList.add('active');
            interval = setInterval(tick, 1000);

            hideAllButtonsExceptReset();

            document.getElementById("p1select").classList.add("hidden");
            document.getElementById("p2select").classList.add("hidden");
        };

        document.getElementById('reset').onclick = () => {
            clearInterval(interval);
            interval = null;

            resetPopup.classList.remove("hidden");
        };

        document.getElementById("resetYes").onclick = () => {
            resetPopup.classList.add("hidden");
            resetTimer();
        };

        document.getElementById("resetNo").onclick = () => {
            resetPopup.classList.add("hidden");

            if (active === 1 || active === 2) {
                interval = setInterval(tick, 1000);
            }
        };

        document.getElementById('setTime').onclick = () => {
            const minutes = prompt('Enter minutes per side (default 15):', 15);
            if (minutes === null) return;
            const m = parseInt(minutes);
            if (isNaN(m) || m < 0) {
                alert('Please enter a valid number.');
                return;
            }
            timeStart = m * 60;
            resetTimer();
        };

        document.getElementById('declareWinner').onclick = () => {
            popup.style.display = "block";
        };

        document.getElementById('whiteWins').onclick = () => {
            popup.style.display = "none";
            endGame(p1name.textContent + " wins by Checkmate", "white");
        };

        document.getElementById('blackWins').onclick = () => {
            popup.style.display = "none";
            endGame(p2name.textContent + " wins by Checkmate", "black");
        };

        document.getElementById('cancelWinner').onclick = () => {
            popup.style.display = "none";
        };

        document.getElementById('declareDraw').onclick = () => {
            endGame("Stalemate — Draw Declared", null);
        };

        update();
    </script>
</body>
</html>

<!-- EOF -->
