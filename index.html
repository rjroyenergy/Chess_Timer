            const black = prompt("Enter Black's name:", p2name.textContent);
            if (black !== null && black.trim() !== "") {
                if (black.toLowerCase() === p1name.textContent.toLowerCase()) {
                    alert("White and Black cannot have the same name.");
                    return;
                }
                p2name.textContent = black;
                saveName(black);
            }

            populateDropdowns();
        };

        swapNamesBtn.onclick = () => {
            const temp = p1name.textContent;
            p1name.textContent = p2name.textContent;
            p2name.textContent = temp;

            const p1select = document.getElementById("p1select");
            const p2select = document.getElementById("p2select");

            const tempSel = p1select.value;
            p1select.value = p2select.value;
            p2select.value = tempSel;

            p1select.value = p1name.textContent;
            p2select.value = p2name.textContent;
        };

        let playerStats = JSON.parse(localStorage.getItem("playerStats") || "{}");

        function saveStats() {
            localStorage.setItem("playerStats", JSON.stringify(playerStats));
        }

        function ensurePlayerStats(name) {
            const key = name.toLowerCase();
            if (!playerStats[key]) {
                playerStats[key] = {
                    name: name,
                    games: 0,
                    wins: 0,
                    losses: 0,
                    draws: 0,
                    timeUsed: 0
                };
            }
        }

        function recordStats(winner, used1, used2) {
            const white = p1name.textContent;
            const black = p2name.textContent;

            const wKey = white.toLowerCase();
            const bKey = black.toLowerCase();

            ensurePlayerStats(white);
            ensurePlayerStats(black);

            playerStats[wKey].games++;
            playerStats[bKey].games++;

            playerStats[wKey].timeUsed += used1;
            playerStats[bKey].timeUsed += used2;

            if (winner === "white") {
                playerStats[wKey].wins++;
                playerStats[bKey].losses++;
            } else if (winner === "black") {
                playerStats[bKey].wins++;
                playerStats[wKey].losses++;
            } else {
                playerStats[wKey].draws++;
                playerStats[bKey].draws++;
            }

            saveStats();
        }

        document.getElementById("viewStats").onclick = () => {
            let msg = "Player Statistics:\n\n";

            for (const key in playerStats) {
                const s = playerStats[key];
                msg += `${s.name}\n`;
                msg += `  Games: ${s.games}\n`;
                msg += `  Wins: ${s.wins}\n`;
                msg += `  Losses: ${s.losses}\n`;
                msg += `  Draws: ${s.draws}\n`;
                msg += `  Total Time Used: ${Math.floor(s.timeUsed / 60)}m ${s.timeUsed % 60}s\n\n`;
            }

            alert(msg);
        };

        function hideAllButtonsExceptReset() {
            startBtn.classList.add('hidden');
            setNamesBtn.classList.add('hidden');
            swapNamesBtn.classList.add('hidden');
            setTimeBtn.classList.add('hidden');
            document.getElementById("declareWinner").classList.add('hidden');
            document.getElementById("declareDraw").classList.add('hidden');
            document.getElementById("viewStats").classList.add('hidden');
        }

        function showAllButtons() {
            startBtn.classList.remove('hidden');
            setNamesBtn.classList.remove('hidden');
            swapNamesBtn.classList.remove('hidden');
            setTimeBtn.classList.remove('hidden');
            document.getElementById("declareWinner").classList.remove('hidden');
            document.getElementById("declareDraw").classList.remove('hidden');
            document.getElementById("viewStats").classList.remove('hidden');
        }

        function updateTimeColors() {
            p1time.classList.remove('low-time', 'flash-time');
            p2time.classList.remove('low-time', 'flash-time');

            const k1 = document.querySelector('#p1 img.king-icon');
            const k2 = document.querySelector('#p2 img.king-icon');

            k1.classList.remove('wobbling');
            k2.classList.remove('wobbling');

            if (t1 <= 10 && t1 > 0) k1.classList.add('wobbling');
            else if (t1 < 30) p1time.classList.add('flash-time');
            else if (t1 < 60) p1time.classList.add('low-time');

            if (t2 <= 10 && t2 > 0) k2.classList.add('wobbling');
            else if (t2 < 30) p2time.classList.add('flash-time');
            else if (t2 < 60) p2time.classList.add('low-time');
        }

        function format(t) {
            const m = Math.floor(t / 60);
            const s = t % 60;
            return String(m).padStart(2, '0') + ':' + String(s).padStart(2, '0');
        }

        function update() {
            p1time.textContent = format(t1);
            p2time.textContent = format(t2);
            updateTimeColors();
        }

        function resetTimer() {
            clearInterval(interval);
            interval = null;
            active = 0;
            t1 = timeStart;
            t2 = timeStart;

            p1.classList.remove('active');
            p2.classList.remove('active');

            const k1 = document.querySelector('#p1 img.king-icon');
            const k2 = document.querySelector('#p2 img.king-icon');
            k1.classList.remove('falling', 'wobbling');
            k2.classList.remove('falling', 'wobbling');

            document.getElementById('crown1').classList.add('hidden');
            document.getElementById('crown2').classList.add('hidden');
            document.getElementById('crown1').classList.remove('crown-animate');
            document.getElementById('crown2').classList.remove('crown-animate');

            p1time.classList.remove('flash-time', 'low-time');
            p2time.classList.remove('flash-time', 'low-time');

            showAllButtons();

            document.getElementById("p1select").classList.remove("hidden");
            document.getElementById("p2select").classList.remove("hidden");

            update();
        }

        function tick() {
            if (active === 1 && t1 > 0) t1--;
            if (active === 2 && t2 > 0) t2--;
            update();

            if (t1 <= 0) endGame("White's time expired — Black wins", "black");
            if (t2 <= 0) endGame("Black's time expired — White wins", "white");
        }

        function endGame(resultText, winner = null) {
            clearInterval(interval);
            interval = null;
            active = 0;

            const k1 = document.querySelector('#p1 img.king-icon');
            const k2 = document.querySelector('#p2 img.king-icon');

            k1.classList.remove('wobbling');
            k2.classList.remove('wobbling');

            p1time.classList.remove('flash-time', 'low-time');
            p2time.classList.remove('flash-time', 'low-time');

            const crown1 = document.getElementById('crown1');
            const crown2 = document.getElementById('crown2');

            crown1.classList.add('hidden');
            crown2.classList.add('hidden');
            crown1.classList.remove('crown-animate');
            crown2.classList.remove('crown-animate');

            if (winner === "white") {
                crown1.classList.remove('hidden');
                void crown1.offsetWidth;
                crown1.classList.add('crown-animate');
                k2.classList.add('falling');
            } else if (winner === "black") {
                crown2.classList.remove('hidden');
                void crown2.offsetWidth;
                crown2.classList.add('crown-animate');
                k1.classList.add('falling');
            }

            hideAllButtonsExceptReset();

            document.getElementById("p1select").classList.remove("hidden");
            document.getElementById("p2select").classList.remove("hidden");

            const used1 = timeStart - t1;
            const used2 = timeStart - t2;

            recordStats(winner, used1, used2);
            showSummary(resultText);
        }

        function showSummary(result) {
            const used1 = timeStart - t1;
            const used2 = timeStart - t2;

            const mins1 = Math.floor(used1 / 60);
            const secs1 = used1 % 60;

            const mins2 = Math.floor(used2 / 60);
            const secs2 = used2 % 60;

            alert(
                "Game Result: " + result + "\n\n" +
                p1name.textContent + " used: " + mins1 + "m " + secs1 + "s\n" +
                p2name.textContent + " used: " + mins2 + "m " + secs2 + "s\n"
            );
        }

        p1.addEventListener('click', () => {
            if (!interval) return;
            playClick();
            active = 2;
            p1.classList.remove('active');
            p2.classList.add('active');
            update();
        });

        p2.addEventListener('click', () => {
            if (!interval) return;
            playClick();
            active = 1;
            p2.classList.remove('active');
            p1.classList.add('active');
            update();
        });

        startBtn.onclick = () => {
            if (interval) return;

            active = 1;
            p1.classList.add('active');
            interval = setInterval(tick, 1000);

            hideAllButtonsExceptReset();

            document.getElementById("p1select").classList.add("hidden");
            document.getElementById("p2select").classList.add("hidden");
        };

        document.getElementById('reset').onclick = () => {
            clearInterval(interval);
            interval = null;

            resetPopup.classList.remove("hidden");
        };

        document.getElementById("resetYes").onclick = () => {
            resetPopup.classList.add("hidden");
            resetTimer();
        };

        document.getElementById("resetNo").onclick = () => {
            resetPopup.classList.add("hidden");

            if (active === 1 || active === 2) {
                interval = setInterval(tick, 1000);
            }
        };

        document.getElementById('setTime').onclick = () => {
            const minutes = prompt('Enter minutes per side (default 15):', 15);
            if (minutes === null) return;
            const m = parseInt(minutes);
            if (isNaN(m) || m < 0) {
                alert('Please enter a valid number.');
                return;
            }
            timeStart = m * 60;
            resetTimer();
        };

        document.getElementById('declareWinner').onclick = () => {
            popup.style.display = "block";
        };

        document.getElementById('whiteWins').onclick = () => {
            popup.style.display = "none";
            endGame(p1name.textContent + " wins by Checkmate", "white");
        };

        document.getElementById('blackWins').onclick = () => {
            popup.style.display = "none";
            endGame(p2name.textContent + " wins by Checkmate", "black");
        };

        document.getElementById('cancelWinner').onclick = () => {
            popup.style.display = "none";
        };

        document.getElementById('declareDraw').onclick = () => {
            endGame("Stalemate — Draw Declared", null);
        };

        update();
    </script>
</body>
</html>

<!-- EOF -->
